<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The House of Biryani's POS</title>

<style>
body{
 margin:0;
 font-family:-apple-system;
 background:#f4f4f8;
}
:root{--p:#6a1b9a;}

.hidden{display:none;}
.glass{
 background:rgba(255,255,255,.75);
 backdrop-filter:blur(18px);
 border-radius:16px;
 padding:12px;
 box-shadow:0 6px 18px rgba(0,0,0,.1);
}

header{
 position:fixed;top:0;width:100%;height:55px;
 background:white;display:flex;align-items:center;
 justify-content:center;font-weight:600;
 border-bottom:1px solid #ddd;z-index:9;
}

main{padding:65px 10px 75px;}

button{
 border:none;border-radius:14px;padding:12px;font-size:16px;
}
.primary{background:var(--p);color:white;width:100%;}
.tabbar{
 position:fixed;bottom:0;width:100%;height:60px;
 background:white;display:flex;border-top:1px solid #ddd;
}
.tabbar button{flex:1;background:none;}
.tabbar .active{color:var(--p);font-weight:600;}

.grid{display:grid;gap:10px;}
@media(min-width:768px){
 .grid{grid-template-columns:2fr 1fr;}
}
input{width:100%;padding:10px;border-radius:12px;border:1px solid #ccc;}
.list{background:white;padding:12px;border-radius:14px;margin:8px 0;}

/* Logo in header */
.logo-small {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    margin-right: 10px;
    object-fit: contain;
}

/* Bill print style */
.bill-print {
    font-family: 'Courier New', monospace;
    width: 80mm;
    padding: 15px;
    margin: 0 auto;
    font-size: 12px;
    line-height: 1.3;
}
.bill-header {
    text-align: center;
    margin-bottom: 10px;
    border-bottom: 1px dashed #000;
    padding-bottom: 10px;
}
.bill-logo {
    width: 40px;
    height: 40px;
    margin: 0 auto 5px;
    display: block;
}
.bill-restaurant {
    font-size: 16px;
    font-weight: bold;
    letter-spacing: 1px;
}
.bill-title {
    font-size: 14px;
    font-weight: bold;
    margin: 5px 0;
}
.bill-info {
    display: flex;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 10px;
}
.bill-divider {
    border-top: 1px dashed #000;
    margin: 8px 0;
}
.bill-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    margin: 10px 0;
}
.bill-table th {
    text-align: left;
    padding: 4px 0;
    border-bottom: 2px solid #000;
}
.bill-table td {
    padding: 3px 0;
    border-bottom: 1px dashed #ccc;
}
.text-center { text-align: center; }
.text-right { text-align: right; }
.bill-total {
    border-top: 2px solid #000;
    margin-top: 10px;
    padding-top: 10px;
    font-weight: bold;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
}
.bill-footer {
    text-align: center;
    margin-top: 15px;
    font-size: 9px;
    border-top: 1px dashed #000;
    padding-top: 8px;
}
.bill-note {
    font-size: 8px;
    color: #666;
    text-align: center;
    margin-top: 10px;
}

/* Sales filters */
.sales-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
}
.filter-btn {
    padding: 6px 12px;
    border: 1px solid #ccc;
    background: white;
    border-radius: 6px;
    font-size: 12px;
}
.filter-btn.active {
    background: var(--p);
    color: white;
    border-color: var(--p);
}

/* Password modal */
.password-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
}
.password-modal.active {
    display: flex;
}
.password-content {
    background: white;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 300px;
    text-align: center;
}

/* Order type buttons */
.order-type-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.order-type-btn {
    flex: 1;
    min-width: calc(50% - 8px);
    padding: 10px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 10px;
    font-size: 12px;
}
.order-type-btn.active {
    border-color: var(--p);
    background: rgba(106, 27, 154, 0.1);
}

/* Bill items preview */
.bill-items-preview {
    font-size: 11px;
    color: #666;
    margin-top: 5px;
}

/* Cart items */
.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.cart-item:last-child {
    border-bottom: none;
}
.cart-item-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}
.cart-item-qty {
    font-weight: bold;
    min-width: 20px;
    text-align: center;
}
.cart-item-remove {
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 12px;
}

/* Menu management */
.menu-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.menu-item:last-child {
    border-bottom: none;
}
.menu-item-controls {
    display: flex;
    gap: 5px;
}
.menu-item-btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: white;
}

/* Delete button in preview */
.delete-bill-btn {
    background: #ff4757;
    color: white;
    margin-top: 10px;
}
</style>
</head>

<body>
<header>
    <img id="headerLogo" class="logo-small hidden" src="" alt="Logo">
    The House of Biryani's
</header>

<main class="grid">

<!-- HOME -->
<section id="home">
<h3>New Bill</h3>

<div class="order-type-buttons">
    <button class="order-type-btn active" onclick="setOrderType('Dine In')">Dine In</button>
    <button class="order-type-btn" onclick="setOrderType('Swiggy')">Swiggy</button>
    <button class="order-type-btn" onclick="setOrderType('Zomato')">Zomato</button>
    <button class="order-type-btn" onclick="setOrderType('Take Away')">Take Away</button>
</div>

<div id="menu"></div>

<h3>Cart</h3>
<div id="cart" class="glass" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>

<h3>Total ₹ <span id="total">0</span></h3>
<button class="primary" onclick="previewBill()">Preview</button>
</section>

<!-- PREVIEW -->
<section id="preview" class="hidden glass">
<h3>Bill Preview</h3>
<div id="billHTML"></div>
<button class="primary" onclick="saveBill()">Save</button>
<button onclick="printBill()">Print</button>
<button class="delete-bill-btn hidden" onclick="deleteCurrentBill()" id="deleteBillBtn">Delete Bill</button>
<button onclick="closePreview()" style="margin-top:10px;background:#666;color:white;">Back</button>
</section>

<!-- BILLS -->
<section id="bills" class="hidden">
<h3>Bills</h3>
<div id="billList"></div>
</section>

<!-- SALES -->
<section id="sales" class="hidden">
<h3>Sales Summary</h3>
<div class="sales-filters">
    <button class="filter-btn active" onclick="loadSales('today')">Today</button>
    <button class="filter-btn" onclick="loadSales('week')">This Week</button>
    <button class="filter-btn" onclick="loadSales('month')">This Month</button>
</div>
<div id="salesData" class="glass"></div>
</section>

<!-- SETTINGS -->
<section id="settings" class="hidden">
<h3>Settings</h3>

<div style="text-align:center;margin-bottom:15px;">
    <img id="settingsLogo" src="" alt="Logo" style="width:60px;height:60px;border-radius:8px;margin:0 auto 10px;display:block;border:2px dashed #ccc;">
    <input type="file" id="logoUpload" accept="image/*" style="display:none;">
    <button onclick="uploadLogo()" style="padding:8px 15px;font-size:12px;">Upload Logo</button>
</div>

<input id="resName" placeholder="Restaurant Name">
<input id="resAddr" placeholder="Address">
<input id="gstNo" placeholder="GST No">
<input id="cgstRate" placeholder="CGST %" type="number" value="2.5">
<input id="sgstRate" placeholder="SGST %" type="number" value="2.5">

<h4 style="margin-top: 20px;">Menu Management</h4>
<div id="menuEditor" class="glass" style="margin-bottom: 15px; max-height: 300px; overflow-y: auto;"></div>
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <input id="newItemName" placeholder="Item Name" style="flex: 2;">
    <input id="newItemPrice" placeholder="Price" type="number" style="flex: 1;">
    <button onclick="addMenuItem()" style="flex: 1;">Add</button>
</div>

<button onclick="saveSettings()" class="primary">Save Settings</button>
<button onclick="changePassword()" style="margin-top:10px;background:#666;color:white;width:100%;">Change Password</button>
</section>

</main>

<div class="tabbar">
<button class="active" onclick="nav(this,'home')">Home</button>
<button onclick="nav(this,'bills');loadBills()">Bills</button>
<button onclick="nav(this,'sales');loadSales('today')">Sales</button>
<button onclick="openSettings(this)">Settings</button>
</div>

<!-- Password Modal -->
<div class="password-modal" id="passwordModal">
    <div class="password-content">
        <h3 style="margin-bottom:15px;">Enter Password</h3>
        <input type="password" id="passwordInput" placeholder="Password" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc;border-radius:8px;">
        <button onclick="checkPassword()" class="primary" style="margin-top:10px;">Unlock Settings</button>
        <button onclick="closePasswordModal()" style="margin-top:10px;background:#666;color:white;width:100%;padding:10px;">Cancel</button>
        <p style="font-size:12px;color:#666;margin-top:15px;">Default password: 1234</p>
    </div>
</div>

<script>
/* ---------- DATA ---------- */
let cart = [];
let db;
let currentOrderType = "Dine In";
let currentBillKey = null; // For deleting bills

// Invoice number counters
const invoiceCounters = {
    'Dine In': parseInt(localStorage.getItem('DI_counter')) || 0,
    'Swiggy': parseInt(localStorage.getItem('SW_counter')) || 0,
    'Zomato': parseInt(localStorage.getItem('ZT_counter')) || 0,
    'Take Away': parseInt(localStorage.getItem('TA_counter')) || 0
};

// Generate invoice number
function generateInvoiceNumber(orderType) {
    const prefixes = {
        'Dine In': 'DI',
        'Swiggy': 'SW',
        'Zomato': 'ZT',
        'Take Away': 'TA'
    };
    
    const prefix = prefixes[orderType];
    let counter = invoiceCounters[orderType];
    
    // Format number with leading zeros (5 digits)
    const formattedNum = counter.toString().padStart(5, '0');
    invoiceCounters[orderType]++;
    
    // Save to localStorage
    localStorage.setItem(`${prefix}_counter`, invoiceCounters[orderType]);
    
    return `${prefix}-${formattedNum}`;
}

// Initialize data
if(!localStorage.menu){
    localStorage.menu = JSON.stringify([
        {name: "Paneer Butter Masala", price: 180},
        {name: "Veg Biryani", price: 150},
        {name: "Tandoori Roti", price: 20},
        {name: "Gulab Jamun", price: 100},
        {name: "Chicken Biryani", price: 220},
        {name: "Butter Chicken", price: 250},
        {name: "Naan", price: 30},
        {name: "Raita", price: 60},
        {name: "Coke", price: 40},
        {name: "Mineral Water", price: 20}
    ]);
}

if(!localStorage.pass) localStorage.pass = "1234";
if(!localStorage.cgstRate) localStorage.cgstRate = "2.5";
if(!localStorage.sgstRate) localStorage.sgstRate = "2.5";
if(!localStorage.resName) localStorage.resName = "The House of Biryani's";

/* ---------- DB ---------- */
let r = indexedDB.open("POS_DB", 2); // Version 2 for upgrades

r.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("bills")) {
        db.createObjectStore("bills", { keyPath: "id", autoIncrement: true });
    }
};

r.onsuccess = e => {
    db = e.target.result;
    loadMenu();
    loadLogo();
    loadSettings();
    loadMenuEditor();
    renderCart();
};

r.onerror = e => {
    console.error("IndexedDB error:", e.target.error);
};

/* ---------- NAV ---------- */
function nav(b, id){
    document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    document.querySelectorAll(".tabbar button").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    if(id === 'home') {
        renderCart();
    }
}

function openSettings(b){
    document.getElementById("passwordModal").classList.add("active");
}

function checkPassword(){
    if(document.getElementById("passwordInput").value === localStorage.pass){
        document.getElementById("passwordModal").classList.remove("active");
        nav(document.querySelector('.tabbar button:nth-child(4)'), 'settings');
        document.querySelectorAll(".tabbar button").forEach(x => x.classList.remove("active"));
        document.querySelector('.tabbar button:nth-child(4)').classList.add("active");
        document.getElementById("passwordInput").value = "";
    } else {
        alert("Wrong password");
    }
}

function closePasswordModal(){
    document.getElementById("passwordModal").classList.remove("active");
    document.getElementById("passwordInput").value = "";
}

function changePassword(){
    const current = prompt("Enter current password:");
    if(current === localStorage.pass){
        const newPass = prompt("Enter new password:");
        if(newPass && newPass.length >= 4){
            localStorage.pass = newPass;
            alert("Password changed successfully!");
        } else {
            alert("Password must be at least 4 characters!");
        }
    } else {
        alert("Wrong current password!");
    }
}

/* ---------- ORDER TYPE ---------- */
function setOrderType(type){
    currentOrderType = type;
    document.querySelectorAll('.order-type-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

/* ---------- LOGO ---------- */
function uploadLogo(){
    document.getElementById("logoUpload").click();
}

document.getElementById("logoUpload").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = function(event){
            localStorage.logo = event.target.result;
            loadLogo();
        };
        reader.readAsDataURL(file);
    }
});

function loadLogo(){
    const logoData = localStorage.logo;
    if(logoData){
        document.getElementById("headerLogo").src = logoData;
        document.getElementById("headerLogo").classList.remove("hidden");
        document.getElementById("settingsLogo").src = logoData;
    }
}

/* ---------- MENU ---------- */
function loadMenu(){
    menu.innerHTML = "";
    JSON.parse(localStorage.menu).forEach(item => {
        let btn = document.createElement("button");
        btn.textContent = `${item.name} ₹${item.price}`;
        btn.style = "background:white;border:1px solid #ddd;margin:5px 0;text-align:left;";
        btn.onclick = () => {
            addToCart(item);
        };
        menu.appendChild(btn);
    });
}

function addToCart(item) {
    // Check if item already in cart
    const existingItem = cart.find(cartItem => cartItem.name === item.name);
    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({...item, quantity: 1});
    }
    renderCart();
    calc();
}

function removeFromCart(itemName) {
    const itemIndex = cart.findIndex(item => item.name === itemName);
    if (itemIndex > -1) {
        cart.splice(itemIndex, 1);
    }
    renderCart();
    calc();
}

function updateQuantity(itemName, change) {
    const item = cart.find(item => item.name === itemName);
    if (item) {
        item.quantity += change;
        if (item.quantity <= 0) {
            removeFromCart(itemName);
        } else {
            renderCart();
            calc();
        }
    }
}

function renderCart() {
    const cartDiv = document.getElementById('cart');
    if (!cartDiv) return;
    
    cartDiv.innerHTML = '';
    
    if (cart.length === 0) {
        cartDiv.innerHTML = '<div style="text-align:center;color:#666;padding:10px;">Cart is empty</div>';
        return;
    }
    
    cart.forEach(item => {
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
            <div>
                <strong>${item.name}</strong><br>
                <small>₹${item.price} × ${item.quantity}</small>
            </div>
            <div class="cart-item-controls">
                <button onclick="updateQuantity('${item.name}', -1)" style="background:#ddd;padding:4px 8px;border-radius:6px;">-</button>
                <span class="cart-item-qty">${item.quantity}</span>
                <button onclick="updateQuantity('${item.name}', 1)" style="background:#ddd;padding:4px 8px;border-radius:6px;">+</button>
                <button onclick="removeFromCart('${item.name}')" class="cart-item-remove">×</button>
            </div>
        `;
        cartDiv.appendChild(cartItem);
    });
}

function calc(){
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('total').textContent = total;
    return total;
}

/* ---------- BILL PREVIEW ---------- */
function previewBill(){
    if(cart.length === 0){
        alert("Please add items first!");
        return;
    }
    
    const subtotal = calc();
    const cgstRate = parseFloat(localStorage.cgstRate || 2.5);
    const sgstRate = parseFloat(localStorage.sgstRate || 2.5);
    const cgstAmt = (subtotal * cgstRate) / 100;
    const sgstAmt = (subtotal * sgstRate) / 100;
    const grand = subtotal + cgstAmt + sgstAmt;
    
    const invoiceNumber = generateInvoiceNumber(currentOrderType);
    
    let billHTML = `
    <div class="bill-print" id="printableBill">
        <div class="bill-header">
            ${localStorage.logo ? `<img src="${localStorage.logo}" class="bill-logo">` : ''}
            <div class="bill-restaurant">${localStorage.resName || "The House of Biryani's"}</div>
            <div class="bill-title">FOOD BILL</div>
        </div>
        
        <div class="bill-info">
            <div>Invoice #: <span>${invoiceNumber}</span></div>
            <div>Date: ${new Date().toLocaleDateString('en-IN')}</div>
        </div>
        
        <div class="bill-divider"></div>
        
        <table class="bill-table">
            <thead>
                <tr>
                    <th>DESCRIPTION</th>
                    <th class="text-center">QTY</th>
                    <th class="text-right">RATE</th>
                    <th class="text-right">AMOUNT</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    cart.forEach(item => {
        billHTML += `
            <tr>
                <td>${item.name}</td>
                <td class="text-center">${item.quantity}</td>
                <td class="text-right">₹${item.price.toFixed(2)}</td>
                <td class="text-right">₹${(item.price * item.quantity).toFixed(2)}</td>
            </tr>
        `;
    });
    
    billHTML += `
            </tbody>
        </table>
        
        <div class="bill-divider"></div>
        
        <div style="font-size:11px;">
            <div style="display:flex;justify-content:space-between;margin:4px 0;">
                <span>Subtotal</span>
                <span>₹${subtotal.toFixed(2)}</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin:4px 0;">
                <span>CGST @ ${cgstRate}%</span>
                <span>₹${cgstAmt.toFixed(2)}</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin:4px 0;">
                <span>SGST @ ${sgstRate}%</span>
                <span>₹${sgstAmt.toFixed(2)}</span>
            </div>
        </div>
        
        <div class="bill-divider"></div>
        
        <div class="bill-total">
            <span>TOTAL</span>
            <span>₹${grand.toFixed(2)}</span>
        </div>
        
        <div class="bill-footer">
            ${localStorage.resAddr ? `<div>${localStorage.resAddr}</div>` : ''}
            ${localStorage.gstNo ? `<div>GST: ${localStorage.gstNo}</div>` : ''}
            <div style="margin-top:10px;">Thank you! Visit Again</div>
        </div>
        
        <div class="bill-note">
            This is a computer generated invoice. No signature required.
        </div>
    </div>
    `;
    
    document.getElementById("billHTML").innerHTML = billHTML;
    document.getElementById("preview").classList.remove("hidden");
    document.getElementById("deleteBillBtn").classList.add("hidden");
    currentBillKey = null;
}

function closePreview(){
    document.getElementById("preview").classList.add("hidden");
}

function saveBill(){
    const subtotal = calc();
    const cgstRate = parseFloat(localStorage.cgstRate || 2.5);
    const sgstRate = parseFloat(localStorage.sgstRate || 2.5);
    const cgstAmt = (subtotal * cgstRate) / 100;
    const sgstAmt = (subtotal * sgstRate) / 100;
    const grand = subtotal + cgstAmt + sgstAmt;
    
    const invoiceNumber = generateInvoiceNumber(currentOrderType);
    
    let bill = {
        items: [...cart],
        orderType: currentOrderType,
        invoiceNumber: invoiceNumber,
        subtotal: subtotal,
        cgstRate: cgstRate,
        sgstRate: sgstRate,
        cgstAmt: cgstAmt,
        sgstAmt: sgstAmt,
        total: grand,
        date: new Date().toISOString()
    };
    
    let tx = db.transaction(["bills"], "readwrite");
    let store = tx.objectStore("bills");
    let request = store.add(bill);
    
    request.onsuccess = function() {
        cart = [];
        renderCart();
        calc();
        closePreview();
        alert("Bill saved successfully!");
    };
    
    request.onerror = function() {
        alert("Error saving bill!");
    };
}

function printBill(){
    const printContent = document.getElementById('printableBill').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    
    // Restore UI
    document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
    document.getElementById("preview").classList.remove("hidden");
    document.querySelectorAll(".tabbar button").forEach(x => x.classList.remove("active"));
    document.querySelector('.tabbar button:nth-child(1)').classList.add("active");
    nav(document.querySelector('.tabbar button:nth-child(1)'), 'home');
}

/* ---------- BILLS HISTORY ---------- */
function loadBills(){
    billList.innerHTML = "";
    let tx = db.transaction(["bills"], "readonly");
    let store = tx.objectStore("bills");
    let request = store.getAll();
    
    request.onsuccess = function(e){
        let bills = e.target.result;
        if(bills.length === 0){
            billList.innerHTML = '<div class="glass" style="text-align:center;padding:20px;color:#666;">No bills found</div>';
            return;
        }
        
        // Sort by date (newest first)
        bills.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        bills.forEach((bill, index) => {
            let date = new Date(bill.date);
            let itemsList = bill.items.slice(0, 2).map(i => i.name).join(', ');
            if(bill.items.length > 2) itemsList += "...";
            
            billList.innerHTML += `
                <div class="list" onclick="viewBill(${index}, '${bill.id}')">
                    <div style="display:flex;justify-content:space-between;">
                        <span style="font-weight:bold;">${bill.invoiceNumber}</span>
                        <span style="color:var(--p);font-weight:bold;">₹${bill.total.toFixed(2)}</span>
                    </div>
                    <div style="font-size:12px;color:#666;">
                        ${date.toLocaleDateString()} • ${date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                    </div>
                    <div style="font-size:11px;color:#888;">${bill.orderType} • ${bill.items.length} items</div>
                </div>
            `;
        });
    };
}

function viewBill(index, id){
    let tx = db.transaction(["bills"], "readonly");
    let store = tx.objectStore("bills");
    let request = store.get(parseInt(id));
    
    request.onsuccess = function(){
        let bill = request.result;
        if(bill){
            currentBillKey = parseInt(id);
            let date = new Date(bill.date);
            
            let billHTML = `
            <div class="bill-print" id="printableBill">
                <div class="bill-header">
                    ${localStorage.logo ? `<img src="${localStorage.logo}" class="bill-logo">` : ''}
                    <div class="bill-restaurant">${localStorage.resName || "The House of Biryani's"}</div>
                    <div class="bill-title">FOOD BILL</div>
                </div>
                
                <div class="bill-info">
                    <div>Invoice #: <span>${bill.invoiceNumber}</span></div>
                    <div>Date: ${date.toLocaleDateString('en-IN')}</div>
                </div>
                
                <div class="bill-divider"></div>
                
                <table class="bill-table">
                    <thead>
                        <tr>
                            <th>DESCRIPTION</th>
                            <th class="text-center">QTY</th>
                            <th class="text-right">RATE</th>
                            <th class="text-right">AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            bill.items.forEach(item => {
                billHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-center">${item.quantity || 1}</td>
                        <td class="text-right">₹${item.price.toFixed(2)}</td>
                        <td class="text-right">₹${((item.quantity || 1) * item.price).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            billHTML += `
                    </tbody>
                </table>
                
                <div class="bill-divider"></div>
                
                <div style="font-size:11px;">
                    <div style="display:flex;justify-content:space-between;margin:4px 0;">
                        <span>Subtotal</span>
                        <span>₹${bill.subtotal.toFixed(2)}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin:4px 0;">
                        <span>CGST @ ${bill.cgstRate}%</span>
                        <span>₹${bill.cgstAmt.toFixed(2)}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin:4px 0;">
                        <span>SGST @ ${bill.sgstRate}%</span>
                        <span>₹${bill.sgstAmt.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="bill-divider"></div>
                
                <div class="bill-total">
                    <span>TOTAL</span>
                    <span>₹${bill.total.toFixed(2)}</span>
                </div>
                
                <div class="bill-footer">
                    ${localStorage.resAddr ? `<div>${localStorage.resAddr}</div>` : ''}
                    ${localStorage.gstNo ? `<div>GST: ${localStorage.gstNo}</div>` : ''}
                    <div style="margin-top:10px;">Thank you! Visit Again</div>
                </div>
            </div>
            `;
            
            document.getElementById("billHTML").innerHTML = billHTML;
            document.getElementById("preview").classList.remove("hidden");
            document.getElementById("deleteBillBtn").classList.remove("hidden");
        }
    };
}

function deleteCurrentBill() {
    if (!currentBillKey) return;
    
    if (confirm("Are you sure you want to delete this bill?")) {
        let tx = db.transaction(["bills"], "readwrite");
        let store = tx.objectStore("bills");
        let request = store.delete(currentBillKey);
        
        request.onsuccess = function() {
            alert("Bill deleted successfully!");
            closePreview();
            loadBills();
            currentBillKey = null;
        };
        
        request.onerror = function() {
            alert("Error deleting bill!");
        };
    }
}

/* ---------- SALES ---------- */
function loadSales(filter){
    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    event.target.classList.add("active");
    
    let tx = db.transaction(["bills"], "readonly");
    let store = tx.objectStore("bills");
    let request = store.getAll();
    
    request.onsuccess = function(){
        let bills = request.result;
        let now = new Date();
        let filteredBills = bills;
        
        // Filter by time
        switch(filter){
            case "today":
                filteredBills = bills.filter(b => {
                    let d = new Date(b.date);
                    return d.toDateString() === now.toDateString();
                });
                break;
            case "week":
                let weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                filteredBills = bills.filter(b => new Date(b.date) >= weekAgo);
                break;
            case "month":
                let monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                filteredBills = bills.filter(b => new Date(b.date) >= monthAgo);
                break;
        }
        
        // Calculate sales by order type
        let salesByType = {
            "Dine In": 0,
            "Swiggy": 0,
            "Zomato": 0,
            "Take Away": 0
        };
        
        let totalRevenue = 0;
        let totalOrders = filteredBills.length;
        
        filteredBills.forEach(bill => {
            salesByType[bill.orderType] = (salesByType[bill.orderType] || 0) + bill.total;
            totalRevenue += bill.total;
        });
        
        // Display sales data
        let html = `
            <div style="font-weight:bold;margin-bottom:10px;">Total Revenue: ₹${totalRevenue.toFixed(2)}</div>
            <div style="margin-bottom:10px;">Total Orders: ${totalOrders}</div>
            
            <div style="font-weight:bold;margin-bottom:10px;margin-top:15px;">Breakdown by Order Type:</div>
        `;
        
        for(let type in salesByType){
            if(salesByType[type] > 0){
                html += `
                    <div style="display:flex;justify-content:space-between;margin:5px 0;padding:5px;background:#f8f9fa;border-radius:5px;">
                        <span>${type}:</span>
                        <span style="font-weight:bold;">₹${salesByType[type].toFixed(2)}</span>
                    </div>
                `;
            }
        }
        
        document.getElementById("salesData").innerHTML = html;
    };
}

/* ---------- SETTINGS ---------- */
function loadSettings(){
    document.getElementById("resName").value = localStorage.resName || "";
    document.getElementById("resAddr").value = localStorage.resAddr || "";
    document.getElementById("gstNo").value = localStorage.gstNo || "";
    document.getElementById("cgstRate").value = localStorage.cgstRate || "2.5";
    document.getElementById("sgstRate").value = localStorage.sgstRate || "2.5";
}

function saveSettings(){
    localStorage.resName = document.getElementById("resName").value;
    localStorage.resAddr = document.getElementById("resAddr").value;
    localStorage.gstNo = document.getElementById("gstNo").value;
    localStorage.cgstRate = document.getElementById("cgstRate").value;
    localStorage.sgstRate = document.getElementById("sgstRate").value;
    alert("Settings saved!");
}

function loadMenuEditor() {
    const menuEditor = document.getElementById('menuEditor');
    const menu = JSON.parse(localStorage.menu || '[]');
    
    menuEditor.innerHTML = '';
    
    menu.forEach((item, index) => {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        menuItem.innerHTML = `
            <div>
                <strong>${item.name}</strong><br>
                <small>₹${item.price}</small>
            </div>
            <div class="menu-item-controls">
                <button onclick="editMenuItem(${index})" class="menu-item-btn">Edit</button>
                <button onclick="deleteMenuItem(${index})" class="menu-item-btn" style="background:#ff4757;color:white;">Delete</button>
            </div>
        `;
        menuEditor.appendChild(menuItem);
    });
}

function addMenuItem() {
    const nameInput = document.getElementById('newItemName');
    const priceInput = document.getElementById('newItemPrice');
    
    const name = nameInput.value.trim();
    const price = parseFloat(priceInput.value);
    
    if (!name || isNaN(price)) {
        alert('Please enter valid item name and price');
        return;
    }
    
    const menu = JSON.parse(localStorage.menu || '[]');
    menu.push({ name, price });
    localStorage.menu = JSON.stringify(menu);
    
    nameInput.value = '';
    priceInput.value = '';
    
    loadMenu();
    loadMenuEditor();
    alert('Menu item added successfully!');
}

function editMenuItem(index) {
    const menu = JSON.parse(localStorage.menu || '[]');
    const item = menu[index];
    
    const newName = prompt('Enter new name:', item.name);
    if (newName === null) return;
    
    const newPrice = prompt('Enter new price:', item.price);
    if (newPrice === null) return;
    
    if (newName && !isNaN(parseFloat(newPrice))) {
        menu[index].name = newName;
        menu[index].price = parseFloat(newPrice);
        localStorage.menu = JSON.stringify(menu);
        
        loadMenu();
        loadMenuEditor();
        alert('Menu item updated successfully!');
    }
}

function deleteMenuItem(index) {
    if (!confirm('Are you sure you want to delete this menu item?')) return;
    
    const menu = JSON.parse(localStorage.menu || '[]');
    menu.splice(index, 1);
    localStorage.menu = JSON.stringify(menu);
    
    loadMenu();
    loadMenuEditor();
    alert('Menu item deleted successfully!');
}
</script>
</body>
</html>
